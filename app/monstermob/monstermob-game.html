<!doctype html>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="monstermob-container.html">
<link rel="import" href="monstermob-card.html">

<dom-module id="monstermob-game">

    <template>
        <style>
            :host {
                cursor: pointer;
                padding: 4px;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            div.flex {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                align-content: space-between;
            }

            paper-button {
                background-color: var(--paper-orange-500) !important;
                color: white !important;
                padding: 4px;
            }
        </style>
        <div class="flex">
            <template is="dom-repeat" items="{{players}}">
                <template is="dom-if" if="{{item.name}}">
                    <monstermob-container container="{{item}}" data="{{data}}">
                    </monstermob-container>
                </template>
                <template is="dom-if" if="{{!item.name}}">
                    <div style="border: 5px solid black;padding: 20px;background-color: white; text-align: center;">
                        <h1>Monster Mob</h1>
                        <template is="dom-if" if="{{isDirection(item, 'left')}}">
                            <iron-icon style="width: 100px;height: 100px;" icon="chevron-left"></iron-icon>
                        </template>
                        <img src="img/Biss.png">
                        <br>
                        <template is="dom-if" if="{{isDirection(item, 'right')}}">
                            <iron-icon style="width: 100px;height: 100px;" icon="chevron-right"></iron-icon>
                        </template>
                        <br>
                        <paper-button on-tap="moveMonster">
                            weiter</paper-button>
                        <paper-button on-tap="rotateMonster">
                            <iron-icon icon="autorenew"></iron-icon>
                            rotate</paper-button>
                    </div>
                </template>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'monstermob-game',
            properties: {
                data: Array,
                players : {
                    type:Array,
                    notify: true,
                    value: function() {
                        return [
                            {name:'player1', life: 2, gold: 1, active:true},
                            {name:'player2', life: 2, gold: 1},
                            {name:'player3', life: 2, gold: 1},
                            {name:'player4', life: 2, gold: 1},
                            {type:'monster', direction: 'left'}
                        ];
                    }
                }
            },
            observers: [
                 'playersChanged(players.splices)'
            ],
             listeners: {
                'finish': 'endTurn'},
            ready: function() {
                this.data = this.shuffle(cards);
                var count = 0;
                for(idx in this.players) {
                    if (this.players[idx].type != 'monster') {
                    this.data[count++].owner = this.players[idx].name;
                    this.data[count++].owner = this.players[idx].name;
                    }
                }
            },
            getMonsterIdx: function() {
                return this.players.map(function(e) { return e.type; }).indexOf('monster');
            },
            playersChanged: function(changeRecord) {
                console.log(changeRecord);
            },
            getMonster: function() {
                return this.players[this.getMonsterIdx()];
            },
            rotateMonster: function() {
                if (this.getMonster().direction == 'left')
                    this.getMonster().direction = 'right';
                else
                    this.getMonster().direction = 'left';
                    this.notifyPath('players.splices');
            },
            moveMonster: function() {
                var index = this.getMonsterIdx();
                var monster = this.players[index];
                var by = (monster.direction == 'left') ? -1 :  1;
                var newPos = index + by % this.players.length;
                this.players.splice(index,1);
                this.players.splice(newPos,0,monster);
            },
            refill: function() {
                var count = 0;
                for(idx in this.players) {
                    var filtered = this.data.filter(isOwner(this.players[idx].name));
                    if (filtered.length == 1) {
                    }
                }
            },
			endTurn: function (e){
                var idx = this.players.findIndex(function(n) {
                return n.active == true; 
                });
                this.players[idx].active = false;
                var nextIdx = (idx+1) % this.players.length;
                if (this.players[nextIdx].type == 'monster') {
                    nextIdx = (nextIdx+1) % this.players.length;
                }
                this.players[nextIdx].active = true;
                console.log(this.players[nextIdx]);
                this.notifyPath('players.*', this.players[nextIdx])
            },
			isDirection: function (item, dir){
                return item.direction == dir;
            },
			isOwner: function (item , own){
                return item.owner == own;
            },
			shuffle: function (o){
			    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
			    return o;
			},
            attached: function() {
            }
        });
    </script>

</dom-module>